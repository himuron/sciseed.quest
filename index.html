<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <title>sAIサーチ / sAIチャット 学習クイズ</title>
  <style>
    
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#0b1223;        /* slightly lighter */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e6edf7;        /* off white */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --ok:#10b981;          /* emerald-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --btn:#2b3c55;         /* 少し明るいボタン地 */
      --btn-border:#3e516d;  /* やや明るい枠線 */
      --ring: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ background:#17355c; } /* 万一の継ぎ目を防ぐ下地 */
    body{
      margin:0;
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP", system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #17355c 0%, #254b7a 100%);
      background-attachment: fixed; /* スクロール時の帯を防止 */
      color:var(--text);
    }
    .container{max-width:980px;margin:0 auto;padding:20px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .card{
      background:rgba(255,255,255,0.07);
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px; padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid{display:grid;gap:14px}
    .grid.cols-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media (max-width:840px){.grid.cols-3{grid-template-columns:1fr}}

    .btn{cursor:pointer; border:1px solid var(--btn-border); background:var(--btn); color:var(--text);
      padding:12px 14px; border-radius:12px; font-weight:600; letter-spacing:.02em; transition:.12s ease; display:inline-flex; align-items:center; gap:8px; justify-content:center}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-color:transparent; color:#07121a}
    .btn.ghost{background:transparent}

    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--btn-border);color:var(--muted)}

    .hero{
      /* 旧）padding:18px 18px 8px; を下記に置換 */
padding: 18px 160px 8px 18px; border-radius:18px; position:relative; overflow:hidden; background: radial-gradient(1200px 200px at 50% -120px, rgba(34,211,238,.25), transparent),
        linear-gradient(180deg, rgba(167,139,250,.18), rgba(255,255,255,0.04));
      border:1px solid rgba(167,139,250,.35);
    }
    .hero h1{margin:8px 0 0; font-size:24px}
    .hero p{margin:6px 0 0; color:var(--muted)}

    .section-title{margin:8px 0 6px; color:var(--muted); font-weight:700; letter-spacing:.05em; font-size:12px}

    .menu button{width:100%; text-align:left}

    .progress{height:10px;border-radius:999px;background:#13233a;border:1px solid rgba(148,163,184,.25); overflow:hidden}
    .progress .bar{height:100%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); width:0}

    /* Question UI */
    .qtitle{font-size:16px; line-height:1.6}
    .choice{display:block; width:100%; text-align:left; padding:12px 14px; border-radius:12px; border:1px solid var(--btn-border); background:rgba(255,255,255,.02); font-weight:600; margin-top:10px}
    .choice.correct{border-color:rgba(16,185,129,.6); background:rgba(16,185,129,.08)}
    .choice.wrong{border-color:rgba(239,68,68,.6); background:rgba(239,68,68,.06)}
    .choice .num{display:inline-flex;align-items:center; justify-content:center; width:28px;height:28px;border-radius:9px;border:1px solid var(--btn-border);margin-right:10px;color:var(--muted); font-weight:800}

    .answer-panel{margin-top:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(148,163,184,.25)}
    .answer-panel summary{cursor:pointer}

    .controls{display:flex; gap:10px; flex-wrap:wrap}

    .big-mark{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition: .25s ease; }
    .big-mark.show{opacity:.98}
    .circle, .cross{ width: 260px; height: 260px; }
    .circle{ border: var(--ring) solid rgba(239,68,68,.9); border-radius:50%; background:transparent; box-shadow: 0 0 60px rgba(239,68,68,.3) inset, 0 0 40px rgba(239,68,68,.35)}
    .cross{ position:relative}
    .cross::before, .cross::after{ content:""; position:absolute; left:50%; top:50%; width: var(--ring); height: 260px; background: rgba(239,68,68,.92); transform:translate(-50%, -50%) rotate(45deg); border-radius:8px; box-shadow: 0 0 50px rgba(239,68,68,.35)}
    .cross::after{ transform:translate(-50%, -50%) rotate(-45deg)}

    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06); border:1px solid rgba(148,163,184,.25); font-size:12px}
    .muted{color:var(--muted)}
    .right{color:var(--ok); font-weight:700}
    .wrongt{color:var(--bad); font-weight:700}

    /* Table */
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(148,163,184,.2); padding:8px 10px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-size:12px}
    tbody tr:hover{background:rgba(255,255,255,.02)}

    .hidden{display:none}
    /* 記述問題の入力文字色を明瞭にする（.hidden の直後に追記） */
input.choice,
textarea.choice {
  color: var(--text);
  caret-color: var(--text);
}

input.choice::placeholder,
textarea.choice::placeholder {
  color: var(--muted);
  opacity: .9;
}

input.choice:disabled,
textarea.choice:disabled {
  color: var(--text);
  opacity: .7;
}
/* === Mobile friendly === */
.btn{ min-height:44px; font-size:16px; }
.choice{ min-height:44px; font-size:16px; }
#qTable input, #qTable textarea, #qTable select{ font-size:16px; min-height:40px; }

/* スマホ時のレイアウト最適化 */
@media (max-width: 640px){
  .controls{ flex-direction:column; }
  .menu .btn{ width:100%; }
  .topbar{ position:sticky; top:0; z-index:10;
           background:rgba(31,47,82,.7); backdrop-filter:blur(6px);
           padding:10px 12px; border-radius:14px; }
}
/* === Mobile usability & visual polish === */

/* タップしやすい最小サイズ・読みやすい文字サイズ */
.btn, .choice, input.choice, textarea.choice, #qTable select {
  min-height: 48px;
  padding: 12px 16px;
  font-size: 16px;
  line-height: 1.25;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* 管理テーブルの入力UIも指で操作しやすく */
#qTable input, #qTable textarea, #qTable select {
  font-size: 16px;
  min-height: 40px;
}

/* 選択肢の番号バッジを少し大きく */
@media (max-width: 640px){
  .choice .num { width: 32px; height: 32px; border-radius: 10px; }
}

/* ボタンを縦積み＆フル幅に（誤タップ防止） */
@media (max-width: 640px){
  .controls { flex-direction: column; gap: 8px; }
  #qCard .controls .btn,
  .menu .btn { width: 100%; }
  #qCard .controls .btn.primary { width: 100%; }
}

/* スマホ時：トップバー固定、操作ボタン群を下部スティッキーに */
@media (max-width: 640px){
  /* 端末のセーフエリア（iOS下部）を考慮して余白を確保 */
  #qCard { padding-bottom: max(88px, env(safe-area-inset-bottom)); }

  /* 黒帯に見えない明るさに変更＋セーフエリア分の下マージン */
  #qCard .controls{
    position: sticky; bottom: 8px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(148,163,184,.18);
    backdrop-filter: blur(10px);
    padding: 12px; border-radius: 14px;
    margin-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
  }

}


/* プログレスやピルもタッチ向けに拡大 */
@media (max-width: 640px){
  .progress { height: 14px; }
  .pill { font-size: 13px; padding: 8px 10px; }
  .card { padding: 14px; border-radius: 16px; }
  .qtitle { font-size: 17px; }
}

/* フォーカス可視化（アクセシビリティ） */
.btn:focus-visible, .choice:focus-visible, input.choice:focus-visible, textarea.choice:focus-visible, #qTable select:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(34,211,238,.5);
  border-color: rgba(34,211,238,.6);
}

/* 端末の省モーション設定に追従 */
@media (prefers-reduced-motion: reduce){
  .big-mark { transition: none; }
}
/* スマホ時：ヘッダー内ボタンを小さく調整 */
@media (max-width: 640px){
  .topbar{ padding: 6px 8px; gap: 6px; border-radius: 12px; }

  /* ヘッダー内ボタンだけサイズを小さく（全体のボタン設定を上書き） */
  .topbar .btn{
    min-height: 36px;
    padding: 6px 10px;
    font-size: 14px;
    line-height: 1.2;
  }

  /* ステータスタグも小さめに */
  .topbar .tag{
    font-size: 11px;
    padding: 4px 8px;
  }

  /* ロゴ周りの縮小 */
  .logo{ font-size: 14px; gap: 6px; }
  .logo .dot{ width: 8px; height: 8px; }
}
/* 選択肢テキストを常に白で表示 */
.choice,
.choice.correct,
.choice.wrong {
  color: #fff !important;
}

/* 無効化後も読めるように */
.choice:disabled {
  color: #fff;
  opacity: .9;
}

/* 番号バッジはやや薄めの白系に */
.choice .num { color: #cbd5e1; }

/* 記述入力欄も白で統一 */
input.choice,
textarea.choice {
  color: #fff;
  caret-color: #fff;
}
input.choice::placeholder,
textarea.choice::placeholder {
  color: rgba(255,255,255,.7);
}
/* --- ページ背景を固定要素に集約（帯対策） --- */
.page-bg{
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  /* 明るめグラデーションを一枚に固定 */
  background: linear-gradient(180deg, #17355c 0%, #254b7a 100%);
  will-change: transform;           /* Safari帯対策 */
  transform: translateZ(0);         /* 帯の出やすい環境での再描画最適化 */
}

/* body本体は背景を持たせない（下の.page-bgを透過させる） */
body{ background: transparent !important; }
/* === 選択肢の枠線を強調（背景は変更しない） === */
.choice{
  border-width: 2px !important;
  border-color: rgba(255,255,255,.38) !important;
  box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset; /* 軽い縁取りでコントラストUP */
}
.choice:hover{
  border-color: rgba(255,255,255,.55) !important;
}
.choice:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(34,211,238,.45), 0 0 0 1px rgba(0,0,0,.25) inset;
}

/* 正誤時も枠だけ強調（背景はそのまま） */
.choice.correct{ border-color: rgba(16,185,129,.9) !important; }
.choice.wrong  { border-color: rgba(239,68,68,.9) !important; }

/* 番号バッジの枠も少し明るく */
.choice .num{ border-color: rgba(255,255,255,.45) !important; }
/* ヒーローに重ねるマスコット */
.mascot-hero{
  position: absolute;
  right: 12px;
  bottom: -6px;
  width: 120px;
  max-width: 30%;
  height: auto;
  user-select: none;
  pointer-events: none;         /* クリック操作を邪魔しない */
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}

/* スマホで少し小さく */
@media (max-width:640px){
  .hero{ padding: 14px 96px 8px 14px; }
  .mascot-hero{ width: 86px; right: 8px; bottom: -4px; }
}
@media (max-width:420px){
  .hero{ padding: 12px 84px 8px 12px; }
  .mascot-hero{ width: 72px; }
}

  </style>
  <!-- CSV & Excel parsers -->
　<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>
<body>
  <div class="big-mark" id="bigMark" aria-hidden="true"></div>
  <div class="page-bg" aria-hidden="true"></div>

  <div class="container">
    <div class="topbar">
      <div class="logo"><span class="dot"></span> CS 学習クイズ</div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn ghost" id="homeTopBtn">ホーム</button>
        <span class="tag" id="statusTag">HOME</span>
        <button class="btn ghost" id="manageBtn">問題管理</button>
        <button class="btn ghost" id="helpBtn">ヘルプ/CSVテンプレート</button>
      </div>
    </div>

    <!-- HOME -->
    <section id="home" class="grid" style="gap:18px">
      <div class="hero">
        <div class="tag">目的：sAIサーチ / sAIチャットの知識定着</div>
        <h1>1問1答で学習！</h1>
        <p>「選択式」「特定分野」「記述式」から学習モードを選んでください。途中で離れても進捗と問題データは自動保存されます。</p>
        <img class="mascot-hero" src="/mascot.png" alt="サイシード・マスコット">
      </div>

      <div class="grid cols-3 menu">
        <div class="card">
          <div class="section-title">全分野 1問1答（選択式）</div>
          <p class="muted">すべての分野の選択式問題からランダムに出題します。</p>
          <button class="btn primary" id="startAllBtn">スタート</button>
        </div>
        <div class="card">
          <div class="section-title">特定分野 1問1答（選択式）</div>
          <div class="grid" id="fieldButtons"></div>
        </div>
        <div class="card">
          <div class="section-title">記述問題</div>
          <p class="muted">記述問題のみを出題します。</p>
          <button class="btn" id="startFreeBtn">スタート</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">トロフィー</div>
        <div id="trophyWrap" class="grid"></div>
      </div>

      <div class="card">
        <div class="section-title">データの入出力</div>
        <div class="grid">
          <div class="controls" id="adminImport">  <!-- 管理者だけ表示 -->
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
  <button class="btn" id="importBtn">アップロードして置き換え</button>
  <button class="btn" id="mergeBtn">アップロードして追加/更新</button>
  <button class="btn" id="exportBtn">現在の問題をCSVで書き出し</button>
  <button class="btn" id="downloadTemplateBtn">CSVテンプレートをダウンロード</button>
  <button class="btn" id="downloadXlsxTemplateBtn">Excelテンプレート(.xlsx)</button>
</div>
<div class="controls">
  <span class="tag" id="syncTag">同期：未接続</span>
</div>
<div id="lastSaved" class="muted" style="font-size:12px"></div>

        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
          <div class="pill" id="modeLabel">モード</div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="pill" id="chapterLabel">章：-</div>
            <div class="pill" id="qIndexLabel">0 / 0</div>
          </div>
        </div>
        <div class="progress" style="margin:10px 0 6px"><div class="bar" id="progressBar"></div></div>
        <div class="muted" id="subStatus"></div>
      </div>

      <div class="card" id="qCard">
        <div id="qText" class="qtitle"></div>
        <div id="choicesWrap"></div>
        <div id="freeWrap" class="hidden" style="display:flex; gap:8px; margin-top:10px">
          <input id="freeInput" class="choice" placeholder="ここに回答を入力"
  inputmode="text" enterkeyhint="done" autocomplete="off" autocapitalize="off" spellcheck="false" />

          <button id="freeSubmit" class="btn">回答する</button>
        </div>

        <div id="answerPanel" class="answer-panel hidden">
          <div id="judgeLine" style="margin-bottom:6px"></div>
          <details>
            <summary id="toggleAnsBtn">解答をひらく</summary>
            <div id="answerText" style="margin-top:8px"></div>
          </details>
        </div>

        <div class="controls" style="margin-top:14px">
          <button class="btn" id="prevBtn">ひとつ前に戻る</button>
          <button class="btn" id="passBtn">この問題をパス</button>
          <button class="btn primary" id="nextBtn" disabled>次の問題へ</button>
          <button class="btn ghost" id="homeBtn">ホーム</button>
        </div>
      </div>
    </section>

    <!-- MANAGE -->
    <section id="manage" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:end; gap:10px; flex-wrap:wrap">
          <div>
            <div class="section-title">問題管理（追加 / 編集 / 削除）</div>
            <div class="muted" style="font-size:12px">各行をクリックして編集。変更は自動保存されます。</div>
          </div>
          <button class="btn" id="addRowBtn">+ 新規問題を追加</button>
        </div>
      </div>
      <div class="card" style="overflow:auto">
        <table id="qTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>章</th>
              <th>分野</th>
              <th>形式</th>
              <th>問題文</th>
              <th>①</th>
              <th>②</th>
              <th>③</th>
              <th>④</th>
              <th>正解</th>
              <th>記述パターン（/regex/可）</th>
              <th>解説</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="qTbody"></tbody>
        </table>
      </div>
      <div class="controls" style="margin-top:10px">
        <button class="btn ghost" id="backHomeFromManage">ホーム</button>
      </div>
    </section>

    <!-- HELP -->
    <section id="help" class="hidden">
      <div class="card">
        <div class="section-title">Excel/CSV 記入ルール</div>
        <ol style="line-height:1.8">
          <li>1行目は必ず以下ヘッダーをコピペしてください<code>id,chapter,field,type,question,choice1,choice2,choice3,choice4,correct,answer_pattern,explanation</code></li>
          <li><b>type</b> は <code>choice</code>（選択式） または <code>free</code>（記述）のみです。</li>
          <li>選択式（choice）の場合：<br>・<b>choice1〜choice4</b> をすべて埋める。<br>・<b>correct（正解）</b> は <u>1〜4 / ①〜④ / A〜D / 選択肢本文いずれか</u>で指定可能（例：<code>2</code> または <code>②</code> または <code>B</code> または <code>選択肢の本文</code>）。</li>
          <li>記述（free）の場合：<br>・<b>answer_pattern</b> を必ず入力。<u>完全一致の文字列</u> か <u>/.../i の正規表現</u> を使用可（例：<code>FAQ</code>、<code>/^faq$/i</code>）。<br>・<b>correct</b> は表示用に任意（模範解答を表示したい場合）。</li>
          <li><b>id</b> は自由に決めてください。空欄の場合は自動採番されます。</li>
          <li>文字列にカンマが含まれる場合は <b>"…"</b> で囲ってください（CSV）。Excelで保存すれば自動で処理されます。</li>
          <li>空白のみの行は無視します。形式エラーの行は取り込み時にスキップし、画面に詳細が表示されます。</li>
        </ol>
        <div class="controls">
          <button class="btn" id="helpBackBtn">ホーム</button>
          <button class="btn" id="downloadTemplateBtn2">CSVテンプレートをダウンロード</button>
          <button class="btn" id="downloadXlsxTemplateBtn2">Excelテンプレート(.xlsx)</button>
        </div>
      </div>
    </section>

  </div>

<script>
/*******************************\
 * 小さなストレージユーティリティ
\*******************************/
const storage = {
  get(key, fallback){
    try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback }catch(e){ return fallback }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); setSavedAt() }
};

function setSavedAt(){
  const el = document.getElementById('lastSaved');
  if(!el) return; const now = new Date();
  el.textContent = `保存: ${now.toLocaleString()}`;
}
/***** 管理者モードとリモート同期設定（必要に応じて変更） *****/
const ADMIN_MODE = false; // ← 管理者用ビルドのみ true に（JS公開でのパスワード運用は不可）

// Googleスプレッドシートを CSV として公開したURL（例）
const REMOTE_CSV_URL =
  "https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/export?format=csv&gid=0";

// 何秒おきに更新を取りに行くか（例：60秒）
const REMOTE_POLL_MS = 60000;

/*******************************\n * 初期データ（サンプル）
 *******************************/
const sampleQuestions = [
  {
    id: 1, chapter: "基礎", field: "sAIサーチ", type: "choice",
    question: "sAIサーチの主目的として最も適切なものはどれ？",
    choice1: "社内FAQの自動生成", choice2: "社内情報の横断検索と即時回答", choice3: "勤怠管理の自動化", choice4: "営業メールの一斉送信",
    correct: "2", answer_pattern: "", explanation: "ナレッジ・ドキュメント・FAQなど社内散在情報を横断検索し、最短で答えに辿り着くための検索体験を提供します。"
  },
  {
    id: 2, chapter: "基礎", field: "sAIチャット", type: "choice",
    question: "sAIチャットが得意とする利用シーンは？",
    choice1: "RPAのデータ整形", choice2: "音声会議の文字起こし", choice3: "問い合わせへの対話型自己解決", choice4: "広告配信の最適化",
    correct: "3", answer_pattern: "", explanation: "顧客や従業員からの問い合わせに対し、チャット体験で自己解決を促進します。"
  },
  {
    id: 3, chapter: "導入", field: "sAIサーチ", type: "choice",
    question: "sAIサーチ導入時の精度改善に最も影響が大きいのは？",
    choice1: "壁紙の色", choice2: "アクセス権限設計", choice3: "ナレッジの構造化/タグ設計", choice4: "PCのスペック",
    correct: "3", answer_pattern: "", explanation: "ドキュメントの構造化・メタデータ設計により検索の関連度が向上します。"
  },
  {
    id: 4, chapter: "運用", field: "sAIチャット", type: "free",
    question: "チャットで意図しない回答が出た際に、学習データの修正や禁止表現を追加することを何という？（カタカナ3文字）",
    choice1: "", choice2: "", choice3: "", choice4: "",
    correct: "ガード", answer_pattern: "/^ガード$/i", explanation: "用語例：『ガード設定』。NGワードや優先FAQの整備など運用チューニングを指します。"
  },
  {
    id: 5, chapter: "運用", field: "共通", type: "choice",
    question: "ログ/ダッシュボードで“解決率”を上げる最初の打ち手として妥当なのは？",
    choice1: "問い合わせ数を増やす", choice2: "未解決セッションの原因分析とFAQ拡充", choice3: "回答速度を遅くする", choice4: "夜間停止",
    correct: "2", answer_pattern: "", explanation: "未解決の原因（情報不足、表記ゆれ、誘導不足）を潰すのが近道です。"
  }
];

/*******************************\n * アプリ状態
 *******************************/
const state = storage.get('sai-quiz-state', {
  mode: 'home', // home | quiz | manage | help
  run: null,    // {modeLabel, list, index, chapter}
  trophies: storage.get('sai-quiz-trophies', {}),
});

let questions = storage.get('sai-quiz-questions', sampleQuestions);

function saveAll(){
  storage.set('sai-quiz-questions', questions);
  storage.set('sai-quiz-state', state);
  storage.set('sai-quiz-trophies', state.trophies);
}

/*******************************\n * 画面切替と共通UI
 *******************************/
function show(section){
  for(const id of ['home','quiz','manage','help']){
    document.getElementById(id).classList.toggle('hidden', id!==section);
  }
  document.getElementById('statusTag').textContent = section.toUpperCase();
  state.mode = section; saveAll();
}

function toastMark(ok){
  const wrap = document.getElementById('bigMark');
  wrap.innerHTML = '';
  const el = document.createElement('div');
  el.className = ok? 'circle' : 'cross';
  wrap.appendChild(el);
  wrap.classList.add('show');
  setTimeout(()=>wrap.classList.remove('show'), 750);
}

function numberToMaru(n){ return ['①','②','③','④'][n-1] }

/*******************************\n * ホーム：分野ボタンとトロフィー
 *******************************/
function unique(arr){ return [...new Set(arr)] }

function refreshHome(){
  // 分野ボタン
  const fields = unique(questions.map(q=>q.field).filter(Boolean));
  const box = document.getElementById('fieldButtons');
  box.innerHTML = '';
  fields.forEach(f=>{
    const b = document.createElement('button');
    b.className = 'btn'; b.textContent = `${f} を出題`;
    b.onclick = ()=> startQuiz({ filter: q=> q.type==='choice' && q.field===f, modeLabel:`特定分野（${f}）` });
    box.appendChild(b);
  });
  // トロフィー
  const chapters = unique(questions.map(q=>q.chapter).filter(Boolean));
  const tw = document.getElementById('trophyWrap'); tw.innerHTML='';
  if(!chapters.length){ tw.textContent = '（章が未登録です）'; return }
  chapters.forEach(ch=>{
    const got = !!state.trophies[ch];
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div><div class="section-title">章</div><div style="font-weight:800">${ch}</div></div>
      <div style="font-size:36px">${got? '🏆' : '🟨'}</div>
    </div>`;
    tw.appendChild(card);
  })
}

/*******************************\n * クイズ実行
 *******************************/
function startQuiz({filter, modeLabel}){
  const list = questions.filter(q=> !filter || filter(q));
  if(list.length===0){ alert('該当する問題がありません'); return }
  // シャッフル
  for(let i=list.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [list[i], list[j]] = [list[j], list[i]] }
  state.run = {
    list, index: storage.get('sai-quiz-progress-index', 0),
    history: [],
    score: 0,
    answered: {}, // id-> {correct, user}
    chapter: list[0].chapter || '（未設定）',
    modeLabel: modeLabel,
  };
  saveAll();
  show('quiz');
  renderQuiz();
}

function renderQuiz(){
  const run = state.run; if(!run){ show('home'); return }
  const total = run.list.length; if(run.index>=total) run.index = total-1;

  // Labels
  byId('modeLabel').textContent = run.modeLabel || '全分野（選択式）';
  byId('chapterLabel').textContent = `章：${run.chapter}`;
  byId('qIndexLabel').textContent = `${run.index+1} / ${total}`;
  byId('progressBar').style.width = `${((run.index)/Math.max(1,total))*100}%`;

  const q = run.list[run.index];
  byId('qText').textContent = q.question;

  // reset panels
  byId('answerPanel').classList.add('hidden');
  byId('choicesWrap').innerHTML='';
  byId('freeWrap').classList.add('hidden');
  byId('nextBtn').disabled = true;

  if(q.type==='choice'){
    const C=[q.choice1,q.choice2,q.choice3,q.choice4];
    C.forEach((text, i)=>{
  const btn=document.createElement('button');
  btn.className='choice';
  const num = document.createElement('span');
  num.className = 'num';
  num.textContent = numberToMaru(i+1);
  btn.appendChild(num);
  btn.appendChild(document.createTextNode(' ' + (text || '')));
  btn.onclick = ()=> onChoice(i+1, q, btn);
  byId('choicesWrap').appendChild(btn);
})

  }else{
    byId('freeWrap').classList.remove('hidden');
    byId('freeInput').value='';
    byId('freeSubmit').onclick = ()=> onFreeSubmit(q);
    const fi = byId('freeInput');
fi.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); onFreeSubmit(q); } };


  }
  

  // sub status
  const a = Object.values(run.answered);
  const solved = a.length; const ok = a.filter(x=>x.correct).length;
  byId('subStatus').textContent = `正解 ${ok} / 回答 ${solved}`;
}

function normalizeCorrect(q){
  // returns 1-4 for choice if possible
  const map = { '1':1,'2':2,'3':3,'4':4, '①':1,'②':2,'③':3,'④':4, 'A':1,'B':2,'C':3,'D':4 };
  if(q.type==='choice'){
    const c = (q.correct||'').toString().trim();
    if(map[c]!==undefined) return map[c];
    const C=[q.choice1,q.choice2,q.choice3,q.choice4];
    const idx = C.findIndex(x=> (x||'').trim() === c);
    return idx>=0? idx+1 : 1; // fallback
  }
  return null;
}

function onChoice(n, q, btn){
  const correctIndex = normalizeCorrect(q);
  const ok = (n===correctIndex);
  judgeAndShow(q, ok, `あなたの選択：${numberToMaru(n)}`);
  // style update
  const buttons = byId('choicesWrap').querySelectorAll('.choice');
  buttons.forEach((b, i)=>{
    if(i+1===correctIndex) b.classList.add('correct');
    if(i+1===n && !ok) b.classList.add('wrong');
    b.disabled = true;
  });
}

function onFreeSubmit(q){
  const input = byId('freeInput').value.trim();
  if(!input){ alert('回答を入力してください'); return }
  let ok = false; 
const pat = (q.answer_pattern || '').trim();

if (pat.startsWith('/') && (pat.endsWith('/i') || pat.endsWith('/'))) {
  const flags = pat.endsWith('/i') ? 'i' : '';
  const body  = pat.slice(1, flags ? -2 : -1);
  if (body.length <= 256) { // 過度な負荷やReDoSを抑止
    try {
      const re = new RegExp(body, flags);
      ok = re.test(input);
    } catch(e) { ok = false; }
  }
}

if (!ok) { // フォールバック：完全一致
  ok = input === pat || input === (q.correct || '');
}

  judgeAndShow(q, ok, `あなたの回答：${input}`);
  byId('freeInput').disabled = true; byId('freeSubmit').disabled=true;
}

function judgeAndShow(q, ok, your){
  toastMark(ok);
  // record
  state.run.answered[q.id||`tmp-${state.run.index}`] = {correct:ok, user:your};
  if(ok) state.run.score++;
  saveAll();

  // answer panel
  byId('answerPanel').classList.remove('hidden');

// judgeLine を安全に生成
const judge = byId('judgeLine');
judge.textContent = '';
const jl = document.createElement('span');
jl.className = ok ? 'right' : 'wrongt';
jl.textContent = ok ? '◯ 正解！' : '× 不正解';
const yourSpan = document.createElement('span');
yourSpan.className = 'muted';
yourSpan.textContent = ` ${your}`;
judge.appendChild(jl);
judge.appendChild(document.createTextNode(' '));
judge.appendChild(yourSpan);

// answerText を安全に生成
const answerText = byId('answerText');
answerText.textContent = '';
const correctDisplay = (q.type === 'choice')
  ? `${numberToMaru(normalizeCorrect(q))}：${[q.choice1,q.choice2,q.choice3,q.choice4][normalizeCorrect(q)-1]}`
  : (q.correct || q.answer_pattern || '');
const c1 = document.createElement('div');
const b  = document.createElement('b'); b.textContent = '正解：';
c1.appendChild(b);
c1.appendChild(document.createTextNode(String(correctDisplay || '')));
const c2 = document.createElement('div');
c2.style.marginTop = '6px';
c2.textContent = q.explanation || '';
answerText.appendChild(c1);
answerText.appendChild(c2);

byId('nextBtn').disabled = false;

  updateProgressAndTrophy();
}

function updateProgressAndTrophy(){
  const run = state.run; if(!run) return;
  const total = run.list.length;
  byId('qIndexLabel').textContent = `${run.index+1} / ${total}`;
  byId('progressBar').style.width = `${((run.index+1)/Math.max(1,total))*100}%`;
}

// navigation
byId('nextBtn').onclick = ()=>{ if(state.run.index < state.run.list.length-1){ state.run.history.push(state.run.index); state.run.index++; saveAll(); renderQuiz() } else { finishRun() } };
byId('prevBtn').onclick = ()=>{ const h=state.run.history; if(h.length){ state.run.index = h.pop(); saveAll(); renderQuiz() } };
byId('passBtn').onclick = ()=>{ if(state.run.index < state.run.list.length-1){ state.run.history.push(state.run.index); state.run.index++; saveAll(); renderQuiz() } else { finishRun() } };
byId('homeBtn').onclick = ()=>{ show('home'); refreshHome() };

function finishRun(){
  // 章トロフィー（30問全問正解）
  const run = state.run;
  const chapter = run.chapter;
  const answeredCount = Object.keys(run.answered).length;
  const allCorrect = answeredCount>=30 && run.score>=30; // 全30問、全正解
  if(allCorrect){
    state.trophies[chapter] = true; saveAll();
    alert(`章「${chapter}」で30問全問正解！\n🏆 トロフィーを獲得しました！`);
  } else {
    alert(`おつかれさまでした！\n正解：${run.score} / 回答：${answeredCount}`);
  }
  show('home'); refreshHome();
}

/*******************************\n * 問題管理テーブル
 *******************************/
  const CHAPTER_OPTIONS = ['基礎','導入','運用'];
　const FIELD_OPTIONS   = ['sAIサーチ','sAIチャット','共通'];
function renderTable(){
  const tbody = byId('qTbody'); tbody.innerHTML='';
  questions.forEach((q,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = [
      cell('id', q.id, i, true),
      cell('chapter', q.chapter, i),
      cell('field', q.field, i),
      cell('type', q.type, i),
      cell('question', q.question, i, false, 36),
      cell('choice1', q.choice1, i, false, 20),
      cell('choice2', q.choice2, i, false, 20),
      cell('choice3', q.choice3, i, false, 20),
      cell('choice4', q.choice4, i, false, 20),
      cell('correct', q.correct, i),
      cell('answer_pattern', q.answer_pattern, i, false, 20),
      cell('explanation', q.explanation, i, false, 36),
      `<td><button class="btn" data-del="${i}">削除</button></td>`
    ].join('');
    tbody.appendChild(tr);
  });
  // bind inputs
  tbody.querySelectorAll('input,textarea,select').forEach(el=>{
    el.addEventListener('change', onCellChange);
  });
  tbody.querySelectorAll('button[data-del]').forEach(b=> b.onclick = ()=>{ const idx=+b.dataset.del; if(confirm('この問題を削除しますか？')){ questions.splice(idx,1); saveAll(); renderTable(); refreshHome(); }});
}

function cell(key, value, idx, readonly=false, max=0){
  const v = value==null? '' : value;

  // ▼ 章・分野・形式はセレクト表示
  if (key==='type' || key==='chapter' || key==='field') {
    if (key==='type') {
      return `<td><select data-idx="${idx}" data-key="type">
        <option value="choice" ${v==='choice'?'selected':''}>choice</option>
        <option value="free"   ${v==='free'  ?'selected':''}>free</option>
      </select></td>`;
    }
    const opts = key==='chapter' ? CHAPTER_OPTIONS : FIELD_OPTIONS;
    return `<td><select data-idx="${idx}" data-key="${key}">`
      + opts.map(o=>`<option value="${o}" ${v===o?'selected':''}>${o}</option>`).join('')
      + `</select></td>`;
  }

  const tag = (String(v).length>40 || max>=36) ? 'textarea' : 'input';
  const attrs = `${readonly?'readonly':''} data-idx="${idx}" data-key="${key}" ${max?`maxlength="${max*4}"`:''}`;
  return `<td>${tag==='input'
    ? `<input value="${escapeHtml(v)}" ${attrs}/>`
    : `<textarea rows="2" ${attrs}>${escapeHtml(v)}</textarea>`}</td>`;
}


function onCellChange(e){
  const el=e.target; const idx=+el.dataset.idx; const key=el.dataset.key; const v=el.value;
  questions[idx][key]=v; if(key==='id') questions[idx].id = isFinite(+v)? +v : v; 
  // ユニークID保証
  if(key==='id'){
    const ids=questions.map(q=>q.id); const dups=ids.filter((x, i)=> ids.indexOf(x)!==i);
    if(dups.length){ alert('IDが重複しています。ユニークになるよう修正してください。'); }
  }
  saveAll();
}

byId('addRowBtn').onclick = ()=>{
  const nextId = genNextId();
  questions.push({ id: nextId, chapter:'新規章', field:'共通', type:'choice', question:'新規問題', choice1:'選択肢1', choice2:'選択肢2', choice3:'選択肢3', choice4:'選択肢4', correct:'1', answer_pattern:'', explanation:'' });
  saveAll(); renderTable(); refreshHome();
}

function genNextId(){
  const ids=questions.map(q=> typeof q.id==='number'? q.id : 0);
  const max=Math.max(0,...ids); return max+1;
}

/*******************************\n * データの入出力
 *******************************/
function readFileToText(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onerror = reject;
    reader.onload = ()=> resolve(reader.result);
    reader.readAsText(file);
  });
}

function parseCsvText(text){
  const res = Papa.parse(text, {header:true, skipEmptyLines:true});
  return res.data.map(row=> rowToQuestion(row));
}

function parseXlsx(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload = (e)=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});
      resolve(json.map(row=> rowToQuestion(row)));
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  })
}

function rowToQuestion(row){
  const q = {
    id: row.id ? isFinite(+row.id) ? +row.id : String(row.id) : undefined,
    chapter: (row.chapter||'').toString().trim() || '未設定',
    field: (row.field||'').toString().trim() || '共通',
    type: (row.type||'choice').toString().trim(),
    question: (row.question||'').toString(),
    choice1: (row.choice1||'').toString(),
    choice2: (row.choice2||'').toString(),
    choice3: (row.choice3||'').toString(),
    choice4: (row.choice4||'').toString(),
    correct: (row.correct||'').toString(),
    answer_pattern: (row.answer_pattern||'').toString(),
    explanation: (row.explanation||'').toString(),
  };
  if(!q.id) q.id = genNextId();
  return q;
}

function mergeQuestions(newQs){
  const map = new Map(questions.map(q=>[String(q.id), q]));
  newQs.forEach(nq=>{ map.set(String(nq.id), {...(map.get(String(nq.id))||{}), ...nq}) });
  questions = Array.from(map.values());
}

function replaceQuestions(newQs){ questions = newQs }

async function handleImport(mode){
  const input = byId('fileInput'); const file = input.files && input.files[0];
  if(!file){ alert('CSV または Excel ファイルを選択してください'); return }
  const ext = file.name.split('.').pop().toLowerCase();
  try{
    const arr = (ext==='csv') ? parseCsvText(await readFileToText(file)) : await parseXlsx(file);
    const cleaned = arr.filter(q=> (q.question||'').trim().length>0 && ['choice','free'].includes(q.type));
    if(mode==='replace') replaceQuestions(cleaned); else mergeQuestions(cleaned);
    saveAll(); renderTable(); refreshHome(); alert(`${cleaned.length}件を${mode==='replace'?'置き換え':'追加/更新'}しました。`)
  }catch(e){ console.error(e); alert('読み込みに失敗しました。ファイル形式とヘッダーを確認してください。') }
}

function downloadCsv(filename, rows){
  const header = ['id','chapter','field','type','question','choice1','choice2','choice3','choice4','correct','answer_pattern','explanation'];
  const lines = [header.join(',')].concat(rows.map(r=> header.map(h=> csvEscape(r[h]??'')).join(',')));
  const blob = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
　const url = URL.createObjectURL(blob);
　const a = document.createElement('a'); a.href = url; a.download = filename;
　document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

}
function csvEscape(v){
  let s = String(v ?? '');
  // Excel 式インジェクション対策：=,+,-,@ で始まる場合は先頭に ' を付与
  if (/^[=+\-@]/.test(s)) s = "'" + s;
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}


function downloadTemplate(){
  const rows = [
    {id:1,chapter:'基礎',field:'sAIサーチ',type:'choice',question:'sAIサーチの主目的は？',choice1:'横断検索と即時回答',choice2:'勤怠管理',choice3:'広告運用',choice4:'在庫管理',correct:'1',answer_pattern:'',explanation:'横断検索..'},
    {id:2,chapter:'基礎',field:'sAIチャット',type:'choice',question:'sAIチャットの得意領域は？',choice1:'対話型自己解決',choice2:'Excel関数',choice3:'画像編集',choice4:'ルーター設定',correct:'1',answer_pattern:'',explanation:''},
    {id:3,chapter:'運用',field:'共通',type:'free',question:'未解決原因の可視化に使う画面名は？',choice1:'',choice2:'',choice3:'',choice4:'',correct:'ダッシュボード',answer_pattern:'/ダッシュボード/i',explanation:'画面名称の例'}
  ];
  downloadCsv('sai_quiz_template.csv', rows);
}

function exportCurrent(){ downloadCsv('sai_quiz_export.csv', questions) }

function downloadXlsxTemplate(){
  const header = ['id','chapter','field','type','question','choice1','choice2','choice3','choice4','correct','answer_pattern','explanation'];
  const data = [header, ...[
    [1,'基礎','sAIサーチ','choice','sAIサーチの主目的は？','横断検索と即時回答','勤怠管理','広告運用','在庫管理','1','', '横断検索..'],
    [2,'基礎','sAIチャット','choice','sAIチャットの得意領域は？','対話型自己解決','Excel関数','画像編集','ルーター設定','1','', ''],
    [3,'運用','共通','free','未解決原因の可視化に使う画面名は？','','','','','ダッシュボード','/ダッシュボード/i','画面名称の例']
  ]];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'questions');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
　const url = URL.createObjectURL(blob);
　const a = document.createElement('a'); a.href = url; a.download = 'sai_quiz_template.xlsx';
　document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

}

/*******************************\n * ヘルパー
 *******************************/
function byId(id){ return document.getElementById(id) }
function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]) }

/*******************************\n * イベント配線
 *******************************/
byId('startAllBtn').onclick = ()=> startQuiz({ filter: q=> q.type==='choice', modeLabel:'全分野（選択式）' });
byId('startFreeBtn').onclick = ()=> startQuiz({ filter: q=> q.type==='free', modeLabel:'記述問題' });
byId('manageBtn').onclick = ()=>{ show('manage'); renderTable() };
byId('backHomeFromManage').onclick = ()=>{ show('home'); refreshHome() };
byId('helpBtn').onclick = ()=>{ show('help') };
byId('homeTopBtn').onclick = ()=>{ show('home'); refreshHome() };
byId('helpBackBtn').onclick = ()=>{ show('home'); refreshHome() };

byId('importBtn').onclick = ()=> handleImport('replace');
byId('mergeBtn').onclick = ()=> handleImport('merge');
byId('exportBtn').onclick = exportCurrent;
byId('downloadTemplateBtn').onclick = downloadTemplate; byId('downloadTemplateBtn2').onclick = downloadTemplate;
byId('downloadXlsxTemplateBtn').onclick = downloadXlsxTemplate; byId('downloadXlsxTemplateBtn2').onclick = downloadXlsxTemplate;

/*******************************\n * 初期表示
 *******************************/
refreshHome();
if(state.mode==='quiz' && state.run){ show('quiz'); renderQuiz() } else if(state.mode==='manage'){ show('manage'); renderTable() } else if(state.mode==='help'){ show('help') } else { show('home') }

</script>
</body>
</html>

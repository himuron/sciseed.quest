<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
 
  <title>sAIã‚µãƒ¼ãƒ / sAIãƒãƒ£ãƒƒãƒˆ å­¦ç¿’ã‚¯ã‚¤ã‚º</title>
  <style>
    
    :root{
      --bg:#0f172a;          /* slate-900 */
      --card:#0b1223;        /* slightly lighter */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e6edf7;        /* off white */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --ok:#10b981;          /* emerald-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --btn:#2b3c55;         /* å°‘ã—æ˜ã‚‹ã„ãƒœã‚¿ãƒ³åœ° */
      --btn-border:#3e516d;  /* ã‚„ã‚„æ˜ã‚‹ã„æ ç·š */
      --ring: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ background:#17355c; } /* ä¸‡ä¸€ã®ç¶™ãç›®ã‚’é˜²ãä¸‹åœ° */
    body{
      margin:0;
      font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Noto Sans JP", system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #17355c 0%, #254b7a 100%);
      background-attachment: fixed; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã®å¸¯ã‚’é˜²æ­¢ */
      color:var(--text);
    }
    .container{max-width:980px;margin:0 auto;padding:20px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px; margin-bottom:16px;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    .card{
      background:rgba(255,255,255,0.07);
      border:1px solid rgba(148,163,184,.25);
      border-radius:18px; padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .grid{display:grid;gap:14px}
    .grid.cols-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    @media (max-width:840px){.grid.cols-3{grid-template-columns:1fr}}

    .btn{cursor:pointer; border:1px solid var(--btn-border); background:var(--btn); color:var(--text);
      padding:12px 14px; border-radius:12px; font-weight:600; letter-spacing:.02em; transition:.12s ease; display:inline-flex; align-items:center; gap:8px; justify-content:center}
    .btn:hover{filter:brightness(1.08)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn.primary{background:linear-gradient(90deg, var(--accent), var(--accent-2)); border-color:transparent; color:#07121a}
    .btn.ghost{background:transparent}

    .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid var(--btn-border);color:var(--muted)}

    .hero{
      /* æ—§ï¼‰padding:18px 18px 8px; ã‚’ä¸‹è¨˜ã«ç½®æ› */
padding: 18px 160px 8px 18px; border-radius:18px; position:relative; overflow:hidden; background: radial-gradient(1200px 200px at 50% -120px, rgba(34,211,238,.25), transparent),
        linear-gradient(180deg, rgba(167,139,250,.18), rgba(255,255,255,0.04));
      border:1px solid rgba(167,139,250,.35);
    }
    .hero h1{margin:8px 0 0; font-size:24px}
    .hero p{margin:6px 0 0; color:var(--muted)}

    .section-title{margin:8px 0 6px; color:var(--muted); font-weight:700; letter-spacing:.05em; font-size:12px}

    .menu button{width:100%; text-align:left}

    .progress{height:10px;border-radius:999px;background:#13233a;border:1px solid rgba(148,163,184,.25); overflow:hidden}
    .progress .bar{height:100%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); width:0}

    /* Question UI */
    .qtitle{font-size:16px; line-height:1.6}
    .choice{display:block; width:100%; text-align:left; padding:12px 14px; border-radius:12px; border:1px solid var(--btn-border); background:rgba(255,255,255,.02); font-weight:600; margin-top:10px}
    .choice.correct{border-color:rgba(16,185,129,.6); background:rgba(16,185,129,.08)}
    .choice.wrong{border-color:rgba(239,68,68,.6); background:rgba(239,68,68,.06)}
    .choice .num{display:inline-flex;align-items:center; justify-content:center; width:28px;height:28px;border-radius:9px;border:1px solid var(--btn-border);margin-right:10px;color:var(--muted); font-weight:800}

    .answer-panel{margin-top:12px; padding:12px; border-radius:12px; background:rgba(255,255,255,.03); border:1px solid rgba(148,163,184,.25)}
    .answer-panel summary{cursor:pointer}

    .controls{display:flex; gap:10px; flex-wrap:wrap}

    .big-mark{ position: fixed; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition: .25s ease; }
    .big-mark.show{opacity:.98}
    .circle, .cross{ width: 260px; height: 260px; }
    .circle{ border: var(--ring) solid rgba(239,68,68,.9); border-radius:50%; background:transparent; box-shadow: 0 0 60px rgba(239,68,68,.3) inset, 0 0 40px rgba(239,68,68,.35)}
    .cross{ position:relative}
    .cross::before, .cross::after{ content:""; position:absolute; left:50%; top:50%; width: var(--ring); height: 260px; background: rgba(239,68,68,.92); transform:translate(-50%, -50%) rotate(45deg); border-radius:8px; box-shadow: 0 0 50px rgba(239,68,68,.35)}
    .cross::after{ transform:translate(-50%, -50%) rotate(-45deg)}

    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06); border:1px solid rgba(148,163,184,.25); font-size:12px}
    .muted{color:var(--muted)}
    .right{color:var(--ok); font-weight:700}
    .wrongt{color:var(--bad); font-weight:700}

    /* Table */
    table{width:100%; border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(148,163,184,.2); padding:8px 10px; text-align:left; vertical-align:top}
    th{color:var(--muted); font-size:12px}
    tbody tr:hover{background:rgba(255,255,255,.02)}

    .hidden{display:none}
    /* è¨˜è¿°å•é¡Œã®å…¥åŠ›æ–‡å­—è‰²ã‚’æ˜ç­ã«ã™ã‚‹ï¼ˆ.hidden ã®ç›´å¾Œã«è¿½è¨˜ï¼‰ */
input.choice,
textarea.choice {
  color: var(--text);
  caret-color: var(--text);
}

input.choice::placeholder,
textarea.choice::placeholder {
  color: var(--muted);
  opacity: .9;
}

input.choice:disabled,
textarea.choice:disabled {
  color: var(--text);
  opacity: .7;
}
/* === Mobile friendly === */
.btn{ min-height:44px; font-size:16px; }
.choice{ min-height:44px; font-size:16px; }
#qTable input, #qTable textarea, #qTable select{ font-size:16px; min-height:40px; }

/* ã‚¹ãƒãƒ›æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ– */
@media (max-width: 640px){
  .controls{ flex-direction:column; }
  .menu .btn{ width:100%; }
  .topbar{ position:sticky; top:0; z-index:10;
           background:rgba(31,47,82,.7); backdrop-filter:blur(6px);
           padding:10px 12px; border-radius:14px; }
}
/* === Mobile usability & visual polish === */

/* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„æœ€å°ã‚µã‚¤ã‚ºãƒ»èª­ã¿ã‚„ã™ã„æ–‡å­—ã‚µã‚¤ã‚º */
.btn, .choice, input.choice, textarea.choice, #qTable select {
  min-height: 48px;
  padding: 12px 16px;
  font-size: 16px;
  line-height: 1.25;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¥åŠ›UIã‚‚æŒ‡ã§æ“ä½œã—ã‚„ã™ã */
#qTable input, #qTable textarea, #qTable select {
  font-size: 16px;
  min-height: 40px;
}

/* é¸æŠè‚¢ã®ç•ªå·ãƒãƒƒã‚¸ã‚’å°‘ã—å¤§ãã */
@media (max-width: 640px){
  .choice .num { width: 32px; height: 32px; border-radius: 10px; }
}

/* ãƒœã‚¿ãƒ³ã‚’ç¸¦ç©ã¿ï¼†ãƒ•ãƒ«å¹…ã«ï¼ˆèª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼‰ */
@media (max-width: 640px){
  .controls { flex-direction: column; gap: 8px; }
  #qCard .controls .btn,
  .menu .btn { width: 100%; }
  #qCard .controls .btn.primary { width: 100%; }
}

/* ã‚¹ãƒãƒ›æ™‚ï¼šãƒˆãƒƒãƒ—ãƒãƒ¼å›ºå®šã€æ“ä½œãƒœã‚¿ãƒ³ç¾¤ã‚’ä¸‹éƒ¨ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ã« */
@media (max-width: 640px){
  /* ç«¯æœ«ã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼ˆiOSä¸‹éƒ¨ï¼‰ã‚’è€ƒæ…®ã—ã¦ä½™ç™½ã‚’ç¢ºä¿ */
  #qCard { padding-bottom: max(88px, env(safe-area-inset-bottom)); }

  /* é»’å¸¯ã«è¦‹ãˆãªã„æ˜ã‚‹ã•ã«å¤‰æ›´ï¼‹ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢åˆ†ã®ä¸‹ãƒãƒ¼ã‚¸ãƒ³ */
  #qCard .controls{
    position: sticky; bottom: 8px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(148,163,184,.18);
    backdrop-filter: blur(10px);
    padding: 12px; border-radius: 14px;
    margin-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 10px 28px rgba(0,0,0,.18);
  }

}


/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚„ãƒ”ãƒ«ã‚‚ã‚¿ãƒƒãƒå‘ã‘ã«æ‹¡å¤§ */
@media (max-width: 640px){
  .progress { height: 14px; }
  .pill { font-size: 13px; padding: 8px 10px; }
  .card { padding: 14px; border-radius: 16px; }
  .qtitle { font-size: 17px; }
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯è¦–åŒ–ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰ */
.btn:focus-visible, .choice:focus-visible, input.choice:focus-visible, textarea.choice:focus-visible, #qTable select:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(34,211,238,.5);
  border-color: rgba(34,211,238,.6);
}

/* ç«¯æœ«ã®çœãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã«è¿½å¾“ */
@media (prefers-reduced-motion: reduce){
  .big-mark { transition: none; }
}
/* ã‚¹ãƒãƒ›æ™‚ï¼šãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ã‚’å°ã•ãèª¿æ•´ */
@media (max-width: 640px){
  .topbar{ padding: 6px 8px; gap: 6px; border-radius: 12px; }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ãƒœã‚¿ãƒ³ã ã‘ã‚µã‚¤ã‚ºã‚’å°ã•ãï¼ˆå…¨ä½“ã®ãƒœã‚¿ãƒ³è¨­å®šã‚’ä¸Šæ›¸ãï¼‰ */
  .topbar .btn{
    min-height: 36px;
    padding: 6px 10px;
    font-size: 14px;
    line-height: 1.2;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ã‚‚å°ã•ã‚ã« */
  .topbar .tag{
    font-size: 11px;
    padding: 4px 8px;
  }

  /* ãƒ­ã‚´å‘¨ã‚Šã®ç¸®å° */
  .logo{ font-size: 14px; gap: 6px; }
  .logo .dot{ width: 8px; height: 8px; }
}
/* é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆã‚’å¸¸ã«ç™½ã§è¡¨ç¤º */
.choice,
.choice.correct,
.choice.wrong {
  color: #fff !important;
}

/* ç„¡åŠ¹åŒ–å¾Œã‚‚èª­ã‚ã‚‹ã‚ˆã†ã« */
.choice:disabled {
  color: #fff;
  opacity: .9;
}

/* ç•ªå·ãƒãƒƒã‚¸ã¯ã‚„ã‚„è–„ã‚ã®ç™½ç³»ã« */
.choice .num { color: #cbd5e1; }

/* è¨˜è¿°å…¥åŠ›æ¬„ã‚‚ç™½ã§çµ±ä¸€ */
input.choice,
textarea.choice {
  color: #fff;
  caret-color: #fff;
}
input.choice::placeholder,
textarea.choice::placeholder {
  color: rgba(255,255,255,.7);
}
/* --- ãƒšãƒ¼ã‚¸èƒŒæ™¯ã‚’å›ºå®šè¦ç´ ã«é›†ç´„ï¼ˆå¸¯å¯¾ç­–ï¼‰ --- */
.page-bg{
  position: fixed;
  inset: 0;
  z-index: -1;
  pointer-events: none;
  /* æ˜ã‚‹ã‚ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¸€æšã«å›ºå®š */
  background: linear-gradient(180deg, #17355c 0%, #254b7a 100%);
  will-change: transform;           /* Safariå¸¯å¯¾ç­– */
  transform: translateZ(0);         /* å¸¯ã®å‡ºã‚„ã™ã„ç’°å¢ƒã§ã®å†æç”»æœ€é©åŒ– */
}

/* bodyæœ¬ä½“ã¯èƒŒæ™¯ã‚’æŒãŸã›ãªã„ï¼ˆä¸‹ã®.page-bgã‚’é€éã•ã›ã‚‹ï¼‰ */
body{ background: transparent !important; }
/* === é¸æŠè‚¢ã®æ ç·šã‚’å¼·èª¿ï¼ˆèƒŒæ™¯ã¯å¤‰æ›´ã—ãªã„ï¼‰ === */
.choice{
  border-width: 2px !important;
  border-color: rgba(255,255,255,.38) !important;
  box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset; /* è»½ã„ç¸å–ã‚Šã§ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆUP */
}
.choice:hover{
  border-color: rgba(255,255,255,.55) !important;
}
.choice:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(34,211,238,.45), 0 0 0 1px rgba(0,0,0,.25) inset;
}

/* æ­£èª¤æ™‚ã‚‚æ ã ã‘å¼·èª¿ï¼ˆèƒŒæ™¯ã¯ãã®ã¾ã¾ï¼‰ */
.choice.correct{ border-color: rgba(16,185,129,.9) !important; }
.choice.wrong  { border-color: rgba(239,68,68,.9) !important; }

/* ç•ªå·ãƒãƒƒã‚¸ã®æ ã‚‚å°‘ã—æ˜ã‚‹ã */
.choice .num{ border-color: rgba(255,255,255,.45) !important; }
/* ãƒ’ãƒ¼ãƒ­ãƒ¼ã«é‡ã­ã‚‹ãƒã‚¹ã‚³ãƒƒãƒˆ */
.mascot-hero{
  position: absolute;
  right: 12px;
  bottom: -6px;
  width: 120px;
  max-width: 30%;
  height: auto;
  user-select: none;
  pointer-events: none;         /* ã‚¯ãƒªãƒƒã‚¯æ“ä½œã‚’é‚ªé­”ã—ãªã„ */
  filter: drop-shadow(0 6px 14px rgba(0,0,0,.25));
}

/* ã‚¹ãƒãƒ›ã§å°‘ã—å°ã•ã */
@media (max-width:640px){
  .hero{ padding: 14px 96px 8px 14px; }
  .mascot-hero{ width: 86px; right: 8px; bottom: -4px; }
}
@media (max-width:420px){
  .hero{ padding: 12px 84px 8px 12px; }
  .mascot-hero{ width: 72px; }
}

  </style>
  <!-- CSV & Excel parsers -->
ã€€<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</head>
<body>
  <div class="big-mark" id="bigMark" aria-hidden="true"></div>
  <div class="page-bg" aria-hidden="true"></div>

  <div class="container">
    <div class="topbar">
      <div class="logo"><span class="dot"></span> CS å­¦ç¿’ã‚¯ã‚¤ã‚º</div>
      <div style="display:flex; gap:8px; align-items:center">
        <button class="btn ghost" id="homeTopBtn">ãƒ›ãƒ¼ãƒ </button>
        <span class="tag" id="statusTag">HOME</span>
        <button class="btn ghost" id="manageBtn">å•é¡Œç®¡ç†</button>
        <button class="btn ghost" id="helpBtn">ãƒ˜ãƒ«ãƒ—/CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
      </div>
    </div>

    <!-- HOME -->
    <section id="home" class="grid" style="gap:18px">
      <div class="hero">
        <div class="tag">ç›®çš„ï¼šsAIã‚µãƒ¼ãƒ / sAIãƒãƒ£ãƒƒãƒˆã®çŸ¥è­˜å®šç€</div>
        <h1>1å•1ç­”ã§å­¦ç¿’ï¼</h1>
        <p>ã€Œé¸æŠå¼ã€ã€Œç‰¹å®šåˆ†é‡ã€ã€Œè¨˜è¿°å¼ã€ã‹ã‚‰å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚é€”ä¸­ã§é›¢ã‚Œã¦ã‚‚é€²æ—ã¨å•é¡Œãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
        <img class="mascot-hero" src="/mascot.png" alt="ã‚µã‚¤ã‚·ãƒ¼ãƒ‰ãƒ»ãƒã‚¹ã‚³ãƒƒãƒˆ">
      </div>

      <div class="grid cols-3 menu">
        <div class="card">
          <div class="section-title">å…¨åˆ†é‡ 1å•1ç­”ï¼ˆé¸æŠå¼ï¼‰</div>
          <p class="muted">ã™ã¹ã¦ã®åˆ†é‡ã®é¸æŠå¼å•é¡Œã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™ã€‚</p>
          <button class="btn primary" id="startAllBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
        <div class="card">
          <div class="section-title">ç‰¹å®šåˆ†é‡ 1å•1ç­”ï¼ˆé¸æŠå¼ï¼‰</div>
          <div class="grid" id="fieldButtons"></div>
        </div>
        <div class="card">
          <div class="section-title">è¨˜è¿°å•é¡Œ</div>
          <p class="muted">è¨˜è¿°å•é¡Œã®ã¿ã‚’å‡ºé¡Œã—ã¾ã™ã€‚</p>
          <button class="btn" id="startFreeBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">ãƒˆãƒ­ãƒ•ã‚£ãƒ¼</div>
        <div id="trophyWrap" class="grid"></div>
      </div>

      <div class="card">
        <div class="section-title">ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›</div>
        <div class="grid">
          <div class="controls" id="adminImport">  <!-- ç®¡ç†è€…ã ã‘è¡¨ç¤º -->
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
  <button class="btn" id="importBtn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç½®ãæ›ãˆ</button>
  <button class="btn" id="mergeBtn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è¿½åŠ /æ›´æ–°</button>
  <button class="btn" id="exportBtn">ç¾åœ¨ã®å•é¡Œã‚’CSVã§æ›¸ãå‡ºã—</button>
  <button class="btn" id="downloadTemplateBtn">CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <button class="btn" id="downloadXlsxTemplateBtn">Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ(.xlsx)</button>
</div>
<div class="controls">
  <span class="tag" id="syncTag">åŒæœŸï¼šæœªæ¥ç¶š</span>
</div>
<div id="lastSaved" class="muted" style="font-size:12px"></div>

        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
          <div class="pill" id="modeLabel">ãƒ¢ãƒ¼ãƒ‰</div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="pill" id="chapterLabel">ç« ï¼š-</div>
            <div class="pill" id="qIndexLabel">0 / 0</div>
          </div>
        </div>
        <div class="progress" style="margin:10px 0 6px"><div class="bar" id="progressBar"></div></div>
        <div class="muted" id="subStatus"></div>
      </div>

      <div class="card" id="qCard">
        <div id="qText" class="qtitle"></div>
        <div id="choicesWrap"></div>
        <div id="freeWrap" class="hidden" style="display:flex; gap:8px; margin-top:10px">
          <input id="freeInput" class="choice" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›"
  inputmode="text" enterkeyhint="done" autocomplete="off" autocapitalize="off" spellcheck="false" />

          <button id="freeSubmit" class="btn">å›ç­”ã™ã‚‹</button>
        </div>

        <div id="answerPanel" class="answer-panel hidden">
          <div id="judgeLine" style="margin-bottom:6px"></div>
          <details>
            <summary id="toggleAnsBtn">è§£ç­”ã‚’ã²ã‚‰ã</summary>
            <div id="answerText" style="margin-top:8px"></div>
          </details>
        </div>

        <div class="controls" style="margin-top:14px">
          <button class="btn" id="prevBtn">ã²ã¨ã¤å‰ã«æˆ»ã‚‹</button>
          <button class="btn" id="passBtn">ã“ã®å•é¡Œã‚’ãƒ‘ã‚¹</button>
          <button class="btn primary" id="nextBtn" disabled>æ¬¡ã®å•é¡Œã¸</button>
          <button class="btn ghost" id="homeBtn">ãƒ›ãƒ¼ãƒ </button>
        </div>
      </div>
    </section>

    <!-- MANAGE -->
    <section id="manage" class="hidden">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:end; gap:10px; flex-wrap:wrap">
          <div>
            <div class="section-title">å•é¡Œç®¡ç†ï¼ˆè¿½åŠ  / ç·¨é›† / å‰Šé™¤ï¼‰</div>
            <div class="muted" style="font-size:12px">å„è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›†ã€‚å¤‰æ›´ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
          </div>
          <button class="btn" id="addRowBtn">+ æ–°è¦å•é¡Œã‚’è¿½åŠ </button>
        </div>
      </div>
      <div class="card" style="overflow:auto">
        <table id="qTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>ç« </th>
              <th>åˆ†é‡</th>
              <th>å½¢å¼</th>
              <th>å•é¡Œæ–‡</th>
              <th>â‘ </th>
              <th>â‘¡</th>
              <th>â‘¢</th>
              <th>â‘£</th>
              <th>æ­£è§£</th>
              <th>è¨˜è¿°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ/regex/å¯ï¼‰</th>
              <th>è§£èª¬</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="qTbody"></tbody>
        </table>
      </div>
      <div class="controls" style="margin-top:10px">
        <button class="btn ghost" id="backHomeFromManage">ãƒ›ãƒ¼ãƒ </button>
      </div>
    </section>

    <!-- HELP -->
    <section id="help" class="hidden">
      <div class="card">
        <div class="section-title">Excel/CSV è¨˜å…¥ãƒ«ãƒ¼ãƒ«</div>
        <ol style="line-height:1.8">
          <li>1è¡Œç›®ã¯å¿…ãšä»¥ä¸‹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„<code>id,chapter,field,type,question,choice1,choice2,choice3,choice4,correct,answer_pattern,explanation</code></li>
          <li><b>type</b> ã¯ <code>choice</code>ï¼ˆé¸æŠå¼ï¼‰ ã¾ãŸã¯ <code>free</code>ï¼ˆè¨˜è¿°ï¼‰ã®ã¿ã§ã™ã€‚</li>
          <li>é¸æŠå¼ï¼ˆchoiceï¼‰ã®å ´åˆï¼š<br>ãƒ»<b>choice1ã€œchoice4</b> ã‚’ã™ã¹ã¦åŸ‹ã‚ã‚‹ã€‚<br>ãƒ»<b>correctï¼ˆæ­£è§£ï¼‰</b> ã¯ <u>1ã€œ4 / â‘ ã€œâ‘£ / Aã€œD / é¸æŠè‚¢æœ¬æ–‡ã„ãšã‚Œã‹</u>ã§æŒ‡å®šå¯èƒ½ï¼ˆä¾‹ï¼š<code>2</code> ã¾ãŸã¯ <code>â‘¡</code> ã¾ãŸã¯ <code>B</code> ã¾ãŸã¯ <code>é¸æŠè‚¢ã®æœ¬æ–‡</code>ï¼‰ã€‚</li>
          <li>è¨˜è¿°ï¼ˆfreeï¼‰ã®å ´åˆï¼š<br>ãƒ»<b>answer_pattern</b> ã‚’å¿…ãšå…¥åŠ›ã€‚<u>å®Œå…¨ä¸€è‡´ã®æ–‡å­—åˆ—</u> ã‹ <u>/.../i ã®æ­£è¦è¡¨ç¾</u> ã‚’ä½¿ç”¨å¯ï¼ˆä¾‹ï¼š<code>FAQ</code>ã€<code>/^faq$/i</code>ï¼‰ã€‚<br>ãƒ»<b>correct</b> ã¯è¡¨ç¤ºç”¨ã«ä»»æ„ï¼ˆæ¨¡ç¯„è§£ç­”ã‚’è¡¨ç¤ºã—ãŸã„å ´åˆï¼‰ã€‚</li>
          <li><b>id</b> ã¯è‡ªç”±ã«æ±ºã‚ã¦ãã ã•ã„ã€‚ç©ºæ¬„ã®å ´åˆã¯è‡ªå‹•æ¡ç•ªã•ã‚Œã¾ã™ã€‚</li>
          <li>æ–‡å­—åˆ—ã«ã‚«ãƒ³ãƒãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ <b>"â€¦"</b> ã§å›²ã£ã¦ãã ã•ã„ï¼ˆCSVï¼‰ã€‚Excelã§ä¿å­˜ã™ã‚Œã°è‡ªå‹•ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚</li>
          <li>ç©ºç™½ã®ã¿ã®è¡Œã¯ç„¡è¦–ã—ã¾ã™ã€‚å½¢å¼ã‚¨ãƒ©ãƒ¼ã®è¡Œã¯å–ã‚Šè¾¼ã¿æ™‚ã«ã‚¹ã‚­ãƒƒãƒ—ã—ã€ç”»é¢ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
        </ol>
        <div class="controls">
          <button class="btn" id="helpBackBtn">ãƒ›ãƒ¼ãƒ </button>
          <button class="btn" id="downloadTemplateBtn2">CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          <button class="btn" id="downloadXlsxTemplateBtn2">Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ(.xlsx)</button>
        </div>
      </div>
    </section>

  </div>

<script>
/*******************************\
 * å°ã•ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
\*******************************/
const storage = {
  get(key, fallback){
    try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback }catch(e){ return fallback }
  },
  set(key, value){ localStorage.setItem(key, JSON.stringify(value)); setSavedAt() }
};

function setSavedAt(){
  const el = document.getElementById('lastSaved');
  if(!el) return; const now = new Date();
  el.textContent = `ä¿å­˜: ${now.toLocaleString()}`;
}
/***** ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã¨ãƒªãƒ¢ãƒ¼ãƒˆåŒæœŸè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰ *****/
const ADMIN_MODE = false; // â† ç®¡ç†è€…ç”¨ãƒ“ãƒ«ãƒ‰ã®ã¿ true ã«ï¼ˆJSå…¬é–‹ã§ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é‹ç”¨ã¯ä¸å¯ï¼‰

// Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ CSV ã¨ã—ã¦å…¬é–‹ã—ãŸURLï¼ˆä¾‹ï¼‰
const REMOTE_CSV_URL =
  "https://docs.google.com/spreadsheets/d/SPREADSHEET_ID/export?format=csv&gid=0";

// ä½•ç§’ãŠãã«æ›´æ–°ã‚’å–ã‚Šã«è¡Œãã‹ï¼ˆä¾‹ï¼š60ç§’ï¼‰
const REMOTE_POLL_MS = 60000;

/*******************************\n * åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
 *******************************/
const sampleQuestions = [
  {
    id: 1, chapter: "åŸºç¤", field: "sAIã‚µãƒ¼ãƒ", type: "choice",
    question: "sAIã‚µãƒ¼ãƒã®ä¸»ç›®çš„ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œï¼Ÿ",
    choice1: "ç¤¾å†…FAQã®è‡ªå‹•ç”Ÿæˆ", choice2: "ç¤¾å†…æƒ…å ±ã®æ¨ªæ–­æ¤œç´¢ã¨å³æ™‚å›ç­”", choice3: "å‹¤æ€ ç®¡ç†ã®è‡ªå‹•åŒ–", choice4: "å–¶æ¥­ãƒ¡ãƒ¼ãƒ«ã®ä¸€æ–‰é€ä¿¡",
    correct: "2", answer_pattern: "", explanation: "ãƒŠãƒ¬ãƒƒã‚¸ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»FAQãªã©ç¤¾å†…æ•£åœ¨æƒ…å ±ã‚’æ¨ªæ–­æ¤œç´¢ã—ã€æœ€çŸ­ã§ç­”ãˆã«è¾¿ã‚Šç€ããŸã‚ã®æ¤œç´¢ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚"
  },
  {
    id: 2, chapter: "åŸºç¤", field: "sAIãƒãƒ£ãƒƒãƒˆ", type: "choice",
    question: "sAIãƒãƒ£ãƒƒãƒˆãŒå¾—æ„ã¨ã™ã‚‹åˆ©ç”¨ã‚·ãƒ¼ãƒ³ã¯ï¼Ÿ",
    choice1: "RPAã®ãƒ‡ãƒ¼ã‚¿æ•´å½¢", choice2: "éŸ³å£°ä¼šè­°ã®æ–‡å­—èµ·ã“ã—", choice3: "å•ã„åˆã‚ã›ã¸ã®å¯¾è©±å‹è‡ªå·±è§£æ±º", choice4: "åºƒå‘Šé…ä¿¡ã®æœ€é©åŒ–",
    correct: "3", answer_pattern: "", explanation: "é¡§å®¢ã‚„å¾“æ¥­å“¡ã‹ã‚‰ã®å•ã„åˆã‚ã›ã«å¯¾ã—ã€ãƒãƒ£ãƒƒãƒˆä½“é¨“ã§è‡ªå·±è§£æ±ºã‚’ä¿ƒé€²ã—ã¾ã™ã€‚"
  },
  {
    id: 3, chapter: "å°å…¥", field: "sAIã‚µãƒ¼ãƒ", type: "choice",
    question: "sAIã‚µãƒ¼ãƒå°å…¥æ™‚ã®ç²¾åº¦æ”¹å–„ã«æœ€ã‚‚å½±éŸ¿ãŒå¤§ãã„ã®ã¯ï¼Ÿ",
    choice1: "å£ç´™ã®è‰²", choice2: "ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­è¨ˆ", choice3: "ãƒŠãƒ¬ãƒƒã‚¸ã®æ§‹é€ åŒ–/ã‚¿ã‚°è¨­è¨ˆ", choice4: "PCã®ã‚¹ãƒšãƒƒã‚¯",
    correct: "3", answer_pattern: "", explanation: "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ§‹é€ åŒ–ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆã«ã‚ˆã‚Šæ¤œç´¢ã®é–¢é€£åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚"
  },
  {
    id: 4, chapter: "é‹ç”¨", field: "sAIãƒãƒ£ãƒƒãƒˆ", type: "free",
    question: "ãƒãƒ£ãƒƒãƒˆã§æ„å›³ã—ãªã„å›ç­”ãŒå‡ºãŸéš›ã«ã€å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ã‚„ç¦æ­¢è¡¨ç¾ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’ä½•ã¨ã„ã†ï¼Ÿï¼ˆã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—ï¼‰",
    choice1: "", choice2: "", choice3: "", choice4: "",
    correct: "ã‚¬ãƒ¼ãƒ‰", answer_pattern: "/^ã‚¬ãƒ¼ãƒ‰$/i", explanation: "ç”¨èªä¾‹ï¼šã€ã‚¬ãƒ¼ãƒ‰è¨­å®šã€ã€‚NGãƒ¯ãƒ¼ãƒ‰ã‚„å„ªå…ˆFAQã®æ•´å‚™ãªã©é‹ç”¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’æŒ‡ã—ã¾ã™ã€‚"
  },
  {
    id: 5, chapter: "é‹ç”¨", field: "å…±é€š", type: "choice",
    question: "ãƒ­ã‚°/ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§â€œè§£æ±ºç‡â€ã‚’ä¸Šã’ã‚‹æœ€åˆã®æ‰“ã¡æ‰‹ã¨ã—ã¦å¦¥å½“ãªã®ã¯ï¼Ÿ",
    choice1: "å•ã„åˆã‚ã›æ•°ã‚’å¢—ã‚„ã™", choice2: "æœªè§£æ±ºã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åŸå› åˆ†æã¨FAQæ‹¡å……", choice3: "å›ç­”é€Ÿåº¦ã‚’é…ãã™ã‚‹", choice4: "å¤œé–“åœæ­¢",
    correct: "2", answer_pattern: "", explanation: "æœªè§£æ±ºã®åŸå› ï¼ˆæƒ…å ±ä¸è¶³ã€è¡¨è¨˜ã‚†ã‚Œã€èª˜å°ä¸è¶³ï¼‰ã‚’æ½°ã™ã®ãŒè¿‘é“ã§ã™ã€‚"
  }
];

/*******************************\n * ã‚¢ãƒ—ãƒªçŠ¶æ…‹
 *******************************/
const state = storage.get('sai-quiz-state', {
  mode: 'home', // home | quiz | manage | help
  run: null,    // {modeLabel, list, index, chapter}
  trophies: storage.get('sai-quiz-trophies', {}),
});

let questions = storage.get('sai-quiz-questions', sampleQuestions);

function saveAll(){
  storage.set('sai-quiz-questions', questions);
  storage.set('sai-quiz-state', state);
  storage.set('sai-quiz-trophies', state.trophies);
}

/*******************************\n * ç”»é¢åˆ‡æ›¿ã¨å…±é€šUI
 *******************************/
function show(section){
  for(const id of ['home','quiz','manage','help']){
    document.getElementById(id).classList.toggle('hidden', id!==section);
  }
  document.getElementById('statusTag').textContent = section.toUpperCase();
  state.mode = section; saveAll();
}

function toastMark(ok){
  const wrap = document.getElementById('bigMark');
  wrap.innerHTML = '';
  const el = document.createElement('div');
  el.className = ok? 'circle' : 'cross';
  wrap.appendChild(el);
  wrap.classList.add('show');
  setTimeout(()=>wrap.classList.remove('show'), 750);
}

function numberToMaru(n){ return ['â‘ ','â‘¡','â‘¢','â‘£'][n-1] }

/*******************************\n * ãƒ›ãƒ¼ãƒ ï¼šåˆ†é‡ãƒœã‚¿ãƒ³ã¨ãƒˆãƒ­ãƒ•ã‚£ãƒ¼
 *******************************/
function unique(arr){ return [...new Set(arr)] }

function refreshHome(){
  // åˆ†é‡ãƒœã‚¿ãƒ³
  const fields = unique(questions.map(q=>q.field).filter(Boolean));
  const box = document.getElementById('fieldButtons');
  box.innerHTML = '';
  fields.forEach(f=>{
    const b = document.createElement('button');
    b.className = 'btn'; b.textContent = `${f} ã‚’å‡ºé¡Œ`;
    b.onclick = ()=> startQuiz({ filter: q=> q.type==='choice' && q.field===f, modeLabel:`ç‰¹å®šåˆ†é‡ï¼ˆ${f}ï¼‰` });
    box.appendChild(b);
  });
  // ãƒˆãƒ­ãƒ•ã‚£ãƒ¼
  const chapters = unique(questions.map(q=>q.chapter).filter(Boolean));
  const tw = document.getElementById('trophyWrap'); tw.innerHTML='';
  if(!chapters.length){ tw.textContent = 'ï¼ˆç« ãŒæœªç™»éŒ²ã§ã™ï¼‰'; return }
  chapters.forEach(ch=>{
    const got = !!state.trophies[ch];
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div><div class="section-title">ç« </div><div style="font-weight:800">${ch}</div></div>
      <div style="font-size:36px">${got? 'ğŸ†' : 'ğŸŸ¨'}</div>
    </div>`;
    tw.appendChild(card);
  })
}

/*******************************\n * ã‚¯ã‚¤ã‚ºå®Ÿè¡Œ
 *******************************/
function startQuiz({filter, modeLabel}){
  const list = questions.filter(q=> !filter || filter(q));
  if(list.length===0){ alert('è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“'); return }
  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  for(let i=list.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [list[i], list[j]] = [list[j], list[i]] }
  state.run = {
    list, index: storage.get('sai-quiz-progress-index', 0),
    history: [],
    score: 0,
    answered: {}, // id-> {correct, user}
    chapter: list[0].chapter || 'ï¼ˆæœªè¨­å®šï¼‰',
    modeLabel: modeLabel,
  };
  saveAll();
  show('quiz');
  renderQuiz();
}

function renderQuiz(){
  const run = state.run; if(!run){ show('home'); return }
  const total = run.list.length; if(run.index>=total) run.index = total-1;

  // Labels
  byId('modeLabel').textContent = run.modeLabel || 'å…¨åˆ†é‡ï¼ˆé¸æŠå¼ï¼‰';
  byId('chapterLabel').textContent = `ç« ï¼š${run.chapter}`;
  byId('qIndexLabel').textContent = `${run.index+1} / ${total}`;
  byId('progressBar').style.width = `${((run.index)/Math.max(1,total))*100}%`;

  const q = run.list[run.index];
  byId('qText').textContent = q.question;

  // reset panels
  byId('answerPanel').classList.add('hidden');
  byId('choicesWrap').innerHTML='';
  byId('freeWrap').classList.add('hidden');
  byId('nextBtn').disabled = true;

  if(q.type==='choice'){
    const C=[q.choice1,q.choice2,q.choice3,q.choice4];
    C.forEach((text, i)=>{
  const btn=document.createElement('button');
  btn.className='choice';
  const num = document.createElement('span');
  num.className = 'num';
  num.textContent = numberToMaru(i+1);
  btn.appendChild(num);
  btn.appendChild(document.createTextNode(' ' + (text || '')));
  btn.onclick = ()=> onChoice(i+1, q, btn);
  byId('choicesWrap').appendChild(btn);
})

  }else{
    byId('freeWrap').classList.remove('hidden');
    byId('freeInput').value='';
    byId('freeSubmit').onclick = ()=> onFreeSubmit(q);
    const fi = byId('freeInput');
fi.onkeydown = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); onFreeSubmit(q); } };


  }
  

  // sub status
  const a = Object.values(run.answered);
  const solved = a.length; const ok = a.filter(x=>x.correct).length;
  byId('subStatus').textContent = `æ­£è§£ ${ok} / å›ç­” ${solved}`;
}

function normalizeCorrect(q){
  // returns 1-4 for choice if possible
  const map = { '1':1,'2':2,'3':3,'4':4, 'â‘ ':1,'â‘¡':2,'â‘¢':3,'â‘£':4, 'A':1,'B':2,'C':3,'D':4 };
  if(q.type==='choice'){
    const c = (q.correct||'').toString().trim();
    if(map[c]!==undefined) return map[c];
    const C=[q.choice1,q.choice2,q.choice3,q.choice4];
    const idx = C.findIndex(x=> (x||'').trim() === c);
    return idx>=0? idx+1 : 1; // fallback
  }
  return null;
}

function onChoice(n, q, btn){
  const correctIndex = normalizeCorrect(q);
  const ok = (n===correctIndex);
  judgeAndShow(q, ok, `ã‚ãªãŸã®é¸æŠï¼š${numberToMaru(n)}`);
  // style update
  const buttons = byId('choicesWrap').querySelectorAll('.choice');
  buttons.forEach((b, i)=>{
    if(i+1===correctIndex) b.classList.add('correct');
    if(i+1===n && !ok) b.classList.add('wrong');
    b.disabled = true;
  });
}

function onFreeSubmit(q){
  const input = byId('freeInput').value.trim();
  if(!input){ alert('å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return }
  let ok = false; 
const pat = (q.answer_pattern || '').trim();

if (pat.startsWith('/') && (pat.endsWith('/i') || pat.endsWith('/'))) {
  const flags = pat.endsWith('/i') ? 'i' : '';
  const body  = pat.slice(1, flags ? -2 : -1);
  if (body.length <= 256) { // éåº¦ãªè² è·ã‚„ReDoSã‚’æŠ‘æ­¢
    try {
      const re = new RegExp(body, flags);
      ok = re.test(input);
    } catch(e) { ok = false; }
  }
}

if (!ok) { // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå®Œå…¨ä¸€è‡´
  ok = input === pat || input === (q.correct || '');
}

  judgeAndShow(q, ok, `ã‚ãªãŸã®å›ç­”ï¼š${input}`);
  byId('freeInput').disabled = true; byId('freeSubmit').disabled=true;
}

function judgeAndShow(q, ok, your){
  toastMark(ok);
  // record
  state.run.answered[q.id||`tmp-${state.run.index}`] = {correct:ok, user:your};
  if(ok) state.run.score++;
  saveAll();

  // answer panel
  byId('answerPanel').classList.remove('hidden');

// judgeLine ã‚’å®‰å…¨ã«ç”Ÿæˆ
const judge = byId('judgeLine');
judge.textContent = '';
const jl = document.createElement('span');
jl.className = ok ? 'right' : 'wrongt';
jl.textContent = ok ? 'â—¯ æ­£è§£ï¼' : 'Ã— ä¸æ­£è§£';
const yourSpan = document.createElement('span');
yourSpan.className = 'muted';
yourSpan.textContent = ` ${your}`;
judge.appendChild(jl);
judge.appendChild(document.createTextNode(' '));
judge.appendChild(yourSpan);

// answerText ã‚’å®‰å…¨ã«ç”Ÿæˆ
const answerText = byId('answerText');
answerText.textContent = '';
const correctDisplay = (q.type === 'choice')
  ? `${numberToMaru(normalizeCorrect(q))}ï¼š${[q.choice1,q.choice2,q.choice3,q.choice4][normalizeCorrect(q)-1]}`
  : (q.correct || q.answer_pattern || '');
const c1 = document.createElement('div');
const b  = document.createElement('b'); b.textContent = 'æ­£è§£ï¼š';
c1.appendChild(b);
c1.appendChild(document.createTextNode(String(correctDisplay || '')));
const c2 = document.createElement('div');
c2.style.marginTop = '6px';
c2.textContent = q.explanation || '';
answerText.appendChild(c1);
answerText.appendChild(c2);

byId('nextBtn').disabled = false;

  updateProgressAndTrophy();
}

function updateProgressAndTrophy(){
  const run = state.run; if(!run) return;
  const total = run.list.length;
  byId('qIndexLabel').textContent = `${run.index+1} / ${total}`;
  byId('progressBar').style.width = `${((run.index+1)/Math.max(1,total))*100}%`;
}

// navigation
byId('nextBtn').onclick = ()=>{ if(state.run.index < state.run.list.length-1){ state.run.history.push(state.run.index); state.run.index++; saveAll(); renderQuiz() } else { finishRun() } };
byId('prevBtn').onclick = ()=>{ const h=state.run.history; if(h.length){ state.run.index = h.pop(); saveAll(); renderQuiz() } };
byId('passBtn').onclick = ()=>{ if(state.run.index < state.run.list.length-1){ state.run.history.push(state.run.index); state.run.index++; saveAll(); renderQuiz() } else { finishRun() } };
byId('homeBtn').onclick = ()=>{ show('home'); refreshHome() };

function finishRun(){
  // ç« ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ï¼ˆ30å•å…¨å•æ­£è§£ï¼‰
  const run = state.run;
  const chapter = run.chapter;
  const answeredCount = Object.keys(run.answered).length;
  const allCorrect = answeredCount>=30 && run.score>=30; // å…¨30å•ã€å…¨æ­£è§£
  if(allCorrect){
    state.trophies[chapter] = true; saveAll();
    alert(`ç« ã€Œ${chapter}ã€ã§30å•å…¨å•æ­£è§£ï¼\nğŸ† ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
  } else {
    alert(`ãŠã¤ã‹ã‚Œã•ã¾ã§ã—ãŸï¼\næ­£è§£ï¼š${run.score} / å›ç­”ï¼š${answeredCount}`);
  }
  show('home'); refreshHome();
}

/*******************************\n * å•é¡Œç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«
 *******************************/
  const CHAPTER_OPTIONS = ['åŸºç¤','å°å…¥','é‹ç”¨'];
ã€€const FIELD_OPTIONS   = ['sAIã‚µãƒ¼ãƒ','sAIãƒãƒ£ãƒƒãƒˆ','å…±é€š'];
function renderTable(){
  const tbody = byId('qTbody'); tbody.innerHTML='';
  questions.forEach((q,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = [
      cell('id', q.id, i, true),
      cell('chapter', q.chapter, i),
      cell('field', q.field, i),
      cell('type', q.type, i),
      cell('question', q.question, i, false, 36),
      cell('choice1', q.choice1, i, false, 20),
      cell('choice2', q.choice2, i, false, 20),
      cell('choice3', q.choice3, i, false, 20),
      cell('choice4', q.choice4, i, false, 20),
      cell('correct', q.correct, i),
      cell('answer_pattern', q.answer_pattern, i, false, 20),
      cell('explanation', q.explanation, i, false, 36),
      `<td><button class="btn" data-del="${i}">å‰Šé™¤</button></td>`
    ].join('');
    tbody.appendChild(tr);
  });
  // bind inputs
  tbody.querySelectorAll('input,textarea,select').forEach(el=>{
    el.addEventListener('change', onCellChange);
  });
  tbody.querySelectorAll('button[data-del]').forEach(b=> b.onclick = ()=>{ const idx=+b.dataset.del; if(confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ questions.splice(idx,1); saveAll(); renderTable(); refreshHome(); }});
}

function cell(key, value, idx, readonly=false, max=0){
  const v = value==null? '' : value;

  // â–¼ ç« ãƒ»åˆ†é‡ãƒ»å½¢å¼ã¯ã‚»ãƒ¬ã‚¯ãƒˆè¡¨ç¤º
  if (key==='type' || key==='chapter' || key==='field') {
    if (key==='type') {
      return `<td><select data-idx="${idx}" data-key="type">
        <option value="choice" ${v==='choice'?'selected':''}>choice</option>
        <option value="free"   ${v==='free'  ?'selected':''}>free</option>
      </select></td>`;
    }
    const opts = key==='chapter' ? CHAPTER_OPTIONS : FIELD_OPTIONS;
    return `<td><select data-idx="${idx}" data-key="${key}">`
      + opts.map(o=>`<option value="${o}" ${v===o?'selected':''}>${o}</option>`).join('')
      + `</select></td>`;
  }

  const tag = (String(v).length>40 || max>=36) ? 'textarea' : 'input';
  const attrs = `${readonly?'readonly':''} data-idx="${idx}" data-key="${key}" ${max?`maxlength="${max*4}"`:''}`;
  return `<td>${tag==='input'
    ? `<input value="${escapeHtml(v)}" ${attrs}/>`
    : `<textarea rows="2" ${attrs}>${escapeHtml(v)}</textarea>`}</td>`;
}


function onCellChange(e){
  const el=e.target; const idx=+el.dataset.idx; const key=el.dataset.key; const v=el.value;
  questions[idx][key]=v; if(key==='id') questions[idx].id = isFinite(+v)? +v : v; 
  // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDä¿è¨¼
  if(key==='id'){
    const ids=questions.map(q=>q.id); const dups=ids.filter((x, i)=> ids.indexOf(x)!==i);
    if(dups.length){ alert('IDãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ãªã‚‹ã‚ˆã†ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚'); }
  }
  saveAll();
}

byId('addRowBtn').onclick = ()=>{
  const nextId = genNextId();
  questions.push({ id: nextId, chapter:'æ–°è¦ç« ', field:'å…±é€š', type:'choice', question:'æ–°è¦å•é¡Œ', choice1:'é¸æŠè‚¢1', choice2:'é¸æŠè‚¢2', choice3:'é¸æŠè‚¢3', choice4:'é¸æŠè‚¢4', correct:'1', answer_pattern:'', explanation:'' });
  saveAll(); renderTable(); refreshHome();
}

function genNextId(){
  const ids=questions.map(q=> typeof q.id==='number'? q.id : 0);
  const max=Math.max(0,...ids); return max+1;
}

/*******************************\n * ãƒ‡ãƒ¼ã‚¿ã®å…¥å‡ºåŠ›
 *******************************/
function readFileToText(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onerror = reject;
    reader.onload = ()=> resolve(reader.result);
    reader.readAsText(file);
  });
}

function parseCsvText(text){
  const res = Papa.parse(text, {header:true, skipEmptyLines:true});
  return res.data.map(row=> rowToQuestion(row));
}

function parseXlsx(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload = (e)=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});
      resolve(json.map(row=> rowToQuestion(row)));
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  })
}

function rowToQuestion(row){
  const q = {
    id: row.id ? isFinite(+row.id) ? +row.id : String(row.id) : undefined,
    chapter: (row.chapter||'').toString().trim() || 'æœªè¨­å®š',
    field: (row.field||'').toString().trim() || 'å…±é€š',
    type: (row.type||'choice').toString().trim(),
    question: (row.question||'').toString(),
    choice1: (row.choice1||'').toString(),
    choice2: (row.choice2||'').toString(),
    choice3: (row.choice3||'').toString(),
    choice4: (row.choice4||'').toString(),
    correct: (row.correct||'').toString(),
    answer_pattern: (row.answer_pattern||'').toString(),
    explanation: (row.explanation||'').toString(),
  };
  if(!q.id) q.id = genNextId();
  return q;
}

function mergeQuestions(newQs){
  const map = new Map(questions.map(q=>[String(q.id), q]));
  newQs.forEach(nq=>{ map.set(String(nq.id), {...(map.get(String(nq.id))||{}), ...nq}) });
  questions = Array.from(map.values());
}

function replaceQuestions(newQs){ questions = newQs }

async function handleImport(mode){
  const input = byId('fileInput'); const file = input.files && input.files[0];
  if(!file){ alert('CSV ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return }
  const ext = file.name.split('.').pop().toLowerCase();
  try{
    const arr = (ext==='csv') ? parseCsvText(await readFileToText(file)) : await parseXlsx(file);
    const cleaned = arr.filter(q=> (q.question||'').trim().length>0 && ['choice','free'].includes(q.type));
    if(mode==='replace') replaceQuestions(cleaned); else mergeQuestions(cleaned);
    saveAll(); renderTable(); refreshHome(); alert(`${cleaned.length}ä»¶ã‚’${mode==='replace'?'ç½®ãæ›ãˆ':'è¿½åŠ /æ›´æ–°'}ã—ã¾ã—ãŸã€‚`)
  }catch(e){ console.error(e); alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚') }
}

function downloadCsv(filename, rows){
  const header = ['id','chapter','field','type','question','choice1','choice2','choice3','choice4','correct','answer_pattern','explanation'];
  const lines = [header.join(',')].concat(rows.map(r=> header.map(h=> csvEscape(r[h]??'')).join(',')));
  const blob = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
ã€€const url = URL.createObjectURL(blob);
ã€€const a = document.createElement('a'); a.href = url; a.download = filename;
ã€€document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

}
function csvEscape(v){
  let s = String(v ?? '');
  // Excel å¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼š=,+,-,@ ã§å§‹ã¾ã‚‹å ´åˆã¯å…ˆé ­ã« ' ã‚’ä»˜ä¸
  if (/^[=+\-@]/.test(s)) s = "'" + s;
  if (s.includes(',') || s.includes('"') || s.includes('\n')) {
    return '"' + s.replace(/"/g,'""') + '"';
  }
  return s;
}


function downloadTemplate(){
  const rows = [
    {id:1,chapter:'åŸºç¤',field:'sAIã‚µãƒ¼ãƒ',type:'choice',question:'sAIã‚µãƒ¼ãƒã®ä¸»ç›®çš„ã¯ï¼Ÿ',choice1:'æ¨ªæ–­æ¤œç´¢ã¨å³æ™‚å›ç­”',choice2:'å‹¤æ€ ç®¡ç†',choice3:'åºƒå‘Šé‹ç”¨',choice4:'åœ¨åº«ç®¡ç†',correct:'1',answer_pattern:'',explanation:'æ¨ªæ–­æ¤œç´¢..'},
    {id:2,chapter:'åŸºç¤',field:'sAIãƒãƒ£ãƒƒãƒˆ',type:'choice',question:'sAIãƒãƒ£ãƒƒãƒˆã®å¾—æ„é ˜åŸŸã¯ï¼Ÿ',choice1:'å¯¾è©±å‹è‡ªå·±è§£æ±º',choice2:'Excelé–¢æ•°',choice3:'ç”»åƒç·¨é›†',choice4:'ãƒ«ãƒ¼ã‚¿ãƒ¼è¨­å®š',correct:'1',answer_pattern:'',explanation:''},
    {id:3,chapter:'é‹ç”¨',field:'å…±é€š',type:'free',question:'æœªè§£æ±ºåŸå› ã®å¯è¦–åŒ–ã«ä½¿ã†ç”»é¢åã¯ï¼Ÿ',choice1:'',choice2:'',choice3:'',choice4:'',correct:'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰',answer_pattern:'/ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰/i',explanation:'ç”»é¢åç§°ã®ä¾‹'}
  ];
  downloadCsv('sai_quiz_template.csv', rows);
}

function exportCurrent(){ downloadCsv('sai_quiz_export.csv', questions) }

function downloadXlsxTemplate(){
  const header = ['id','chapter','field','type','question','choice1','choice2','choice3','choice4','correct','answer_pattern','explanation'];
  const data = [header, ...[
    [1,'åŸºç¤','sAIã‚µãƒ¼ãƒ','choice','sAIã‚µãƒ¼ãƒã®ä¸»ç›®çš„ã¯ï¼Ÿ','æ¨ªæ–­æ¤œç´¢ã¨å³æ™‚å›ç­”','å‹¤æ€ ç®¡ç†','åºƒå‘Šé‹ç”¨','åœ¨åº«ç®¡ç†','1','', 'æ¨ªæ–­æ¤œç´¢..'],
    [2,'åŸºç¤','sAIãƒãƒ£ãƒƒãƒˆ','choice','sAIãƒãƒ£ãƒƒãƒˆã®å¾—æ„é ˜åŸŸã¯ï¼Ÿ','å¯¾è©±å‹è‡ªå·±è§£æ±º','Excelé–¢æ•°','ç”»åƒç·¨é›†','ãƒ«ãƒ¼ã‚¿ãƒ¼è¨­å®š','1','', ''],
    [3,'é‹ç”¨','å…±é€š','free','æœªè§£æ±ºåŸå› ã®å¯è¦–åŒ–ã«ä½¿ã†ç”»é¢åã¯ï¼Ÿ','','','','','ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰','/ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰/i','ç”»é¢åç§°ã®ä¾‹']
  ]];
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'questions');
  const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
  const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
ã€€const url = URL.createObjectURL(blob);
ã€€const a = document.createElement('a'); a.href = url; a.download = 'sai_quiz_template.xlsx';
ã€€document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);

}

/*******************************\n * ãƒ˜ãƒ«ãƒ‘ãƒ¼
 *******************************/
function byId(id){ return document.getElementById(id) }
function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]) }

/*******************************\n * ã‚¤ãƒ™ãƒ³ãƒˆé…ç·š
 *******************************/
byId('startAllBtn').onclick = ()=> startQuiz({ filter: q=> q.type==='choice', modeLabel:'å…¨åˆ†é‡ï¼ˆé¸æŠå¼ï¼‰' });
byId('startFreeBtn').onclick = ()=> startQuiz({ filter: q=> q.type==='free', modeLabel:'è¨˜è¿°å•é¡Œ' });
byId('manageBtn').onclick = ()=>{ show('manage'); renderTable() };
byId('backHomeFromManage').onclick = ()=>{ show('home'); refreshHome() };
byId('helpBtn').onclick = ()=>{ show('help') };
byId('homeTopBtn').onclick = ()=>{ show('home'); refreshHome() };
byId('helpBackBtn').onclick = ()=>{ show('home'); refreshHome() };

byId('importBtn').onclick = ()=> handleImport('replace');
byId('mergeBtn').onclick = ()=> handleImport('merge');
byId('exportBtn').onclick = exportCurrent;
byId('downloadTemplateBtn').onclick = downloadTemplate; byId('downloadTemplateBtn2').onclick = downloadTemplate;
byId('downloadXlsxTemplateBtn').onclick = downloadXlsxTemplate; byId('downloadXlsxTemplateBtn2').onclick = downloadXlsxTemplate;

/*******************************\n * åˆæœŸè¡¨ç¤º
 *******************************/
refreshHome();
if(state.mode==='quiz' && state.run){ show('quiz'); renderQuiz() } else if(state.mode==='manage'){ show('manage'); renderTable() } else if(state.mode==='help'){ show('help') } else { show('home') }

</script>
</body>
</html>
